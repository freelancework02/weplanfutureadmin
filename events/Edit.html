<!doctype html>
<html lang="en" class="h-full" data-root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin | Edit Event</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../assets/css/custom.css" />
  <style>
    .thumb{aspect-ratio:4/3;object-fit:cover;border-radius:.5rem}
    .cover-ring{box-shadow:0 0 0 3px rgba(16,185,129,.85) inset}
    /* unify card backgrounds */
    .card { background: #ffffff; }
    .dark .card { background: #111827; }
  </style>
</head>
<body class="h-full bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
  <div id="backdrop" class="fixed inset-0 bg-black/40 opacity-0 pointer-events-none lg:hidden"></div>
  <aside id="sidebar" class="fixed top-0 left-0 z-40 h-full w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700">
    <div class="flex items-center gap-3 px-5 h-16 border-b border-gray-200 dark:border-gray-700">
      <div class="size-9 rounded-lg bg-emerald-600"></div>
      <div class="font-semibold">Admin Panel</div>
    </div>
    <nav class="p-3 space-y-1">
      <a href="../index.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">üè† Dashboard</a>
      <a href="./" class="flex items-center gap-3 px-3 py-2 rounded-lg bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">üìÖ Events</a>
      <a href="../gallery/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">üñºÔ∏è Gallery</a>
      <a href="../blogs/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">üìù Blogs</a>
    </nav>
  </aside>

  <div class="lg:pl-72 min-h-full">
    <header class="sticky top-0 z-30 bg-white/80 dark:bg-gray-800/80 backdrop-blur border-b border-gray-200 dark:border-gray-700">
      <div class="h-16 px-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button class="lg:hidden p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700" data-toggle="sidebar">‚ò∞</button>
          <div>
            <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Events</p>
            <h1 class="text-lg font-semibold">Edit Event</h1>
          </div>
        </div>
        <div class="flex gap-2">
          <button class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700" data-toggle="theme">üåì</button>
          <a id="viewLink" href="#" class="px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-100 dark:border-gray-700 dark:hover:bg-gray-700">View</a>
          <a href="./" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-100 dark:border-gray-700 dark:text-gray-200 dark:hover:bg-gray-700">
            ‚Üê Back to Events
          </a>
        </div>
      </div>
    </header>

    <main class="p-6" data-api-base="https://weplanfuture.com/api" classname="bg-gray-800">
      <form id="form" class="max-w-4xl mx-auto rounded-2xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm space-y-6 bg-white dark:bg-gray-800" enctype="multipart/form-data">
        <input type="hidden" id="eventId" />
        <div>
          <label class="block text-sm font-medium">Title</label>
          <input id="title" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 px-3 py-2 bg-white dark:bg-gray-900" />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium">Date</label>
            <input id="eventDate" type="datetime-local" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 px-3 py-2 bg-white dark:bg-gray-900" />
          </div>
          <div>
            <label class="block text-sm font-medium">Hosted By</label>
            <input id="hostedBy" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 px-3 py-2 bg-white dark:bg-gray-900" />
          </div>
          <div>
            <label class="block text-sm font-medium">Link</label>
            <input id="link" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 px-3 py-2 bg-white dark:bg-gray-900" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium">Address</label>
          <input id="address" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 px-3 py-2 bg-white dark:bg-gray-900" />
        </div>

        <div>
          <label class="block text-sm font-medium">Description</label>
          <textarea id="description" rows="5" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 px-3 py-2 bg-white dark:bg-gray-900"></textarea>
        </div>

        <div class="flex items-center gap-3">
          <input id="isPublished" type="checkbox" class="h-4 w-4" />
          <label for="isPublished" class="text-sm">Published</label>
        </div>

        <section>
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Existing Photos</h3>
            <div class="text-xs text-gray-500">Set cover or remove images</div>
          </div>
          <div id="existingGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
        </section>

        <section>
          <label class="block text-sm font-medium mb-2">Add New Photos</label>
          <div id="dropzone" class="rounded-xl border-2 border-dashed p-6 text-center bg-gray-50 dark:bg-gray-900 dark:border-gray-700">
            <p class="font-medium">Drag & drop or choose files</p>
            <div class="mt-3">
              <label class="inline-flex items-center px-4 py-2 rounded-lg bg-indigo-600 text-white cursor-pointer">
                Choose files <input id="images" type="file" multiple accept="image/*" class="hidden" />
              </label>
            </div>
            <p class="text-xs text-gray-500 mt-3">Max 50 images total. Each up to 8MB.</p>
          </div>
          <div id="newPreview" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
        </section>

        <div class="flex justify-between items-center">
          <button id="resetBtn" type="button" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 dark:border-gray-700 dark:hover:bg-gray-700">Reset</button>
          <div class="flex gap-2">
            <button id="deleteBtn" type="button" class="px-4 py-2 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 dark:border-red-900/40 dark:hover:bg-red-900/20">Delete Event</button>
            <button id="saveBtn" type="submit" class="px-5 py-2.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Save changes</button>
          </div>
        </div>

        <div id="alert" class="hidden mt-2 p-3 rounded-lg text-sm"></div>
      </form>
    </main>
  </div>

  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/notifications.js"></script>
  <script>
    (function baseUI(){
      document.querySelectorAll('[data-toggle="sidebar"]').forEach(btn=>{
        btn.addEventListener('click',()=>document.documentElement.classList.toggle('sidebar-open'));
      });
      const themeBtn = document.querySelector('[data-toggle="theme"]');
      const setTheme = t => { document.documentElement.classList.toggle('dark', t==='dark'); localStorage.setItem('theme', t); };
      if (themeBtn) themeBtn.addEventListener('click',()=>setTheme(document.documentElement.classList.contains('dark')?'light':'dark'));
      const stored = localStorage.getItem('theme'); if (stored) setTheme(stored);
    })();

    (function(){
      window.Auth?.requireAuth();

      const API_BASE = document.querySelector('main').getAttribute('data-api-base').replace(/\/$/,'');
      const params = new URLSearchParams(location.search);
      const id = params.get('id');

      const form = document.getElementById('form');
      const eventIdFld = document.getElementById('eventId');
      const title = document.getElementById('title');
      const eventDate = document.getElementById('eventDate');
      const hostedBy = document.getElementById('hostedBy');
      const link = document.getElementById('link');
      const address = document.getElementById('address');
      const description = document.getElementById('description');
      const isPublished = document.getElementById('isPublished');
      const existingGrid = document.getElementById('existingGrid');
      const imagesInput = document.getElementById('images');
      const newPreview = document.getElementById('newPreview');
      const dropzone = document.getElementById('dropzone');
      const saveBtn = document.getElementById('saveBtn');
      const deleteBtn = document.getElementById('deleteBtn');
      const resetBtn = document.getElementById('resetBtn');
      const viewLink = document.getElementById('viewLink');
      const alertBox = document.getElementById('alert');

      let existing = []; // {id,image_name}
      let deletedIds = new Set();
      let newFiles = [];

      function show(msg, type='info', ms=3000){
        alertBox.className = 'mt-2 p-3 rounded-lg text-sm ' + (type==='error' ? 'bg-red-50 text-red-800 border border-red-200' : 'bg-emerald-50 text-emerald-800 border border-emerald-200');
        alertBox.textContent = msg;
        alertBox.classList.remove('hidden');
        if (ms) setTimeout(()=> alertBox.classList.add('hidden'), ms);
      }

      function imgUrl(id){ return API_BASE + '/events/image/' + encodeURIComponent(id) + '/blob'; }

      function toDateTimeLocal(src){
        if(!src) return '';
        // server format like "2025-11-18 10:00:00" or ISO
        const d = new Date(String(src).replace(' ', 'T'));
        if (isNaN(d.getTime())) return '';
        const pad = (n)=> String(n).padStart(2,'0');
        const yyyy = d.getFullYear();
        const mm = pad(d.getMonth()+1);
        const dd = pad(d.getDate());
        const hh = pad(d.getHours());
        const min = pad(d.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
      }

      function fromDateTimeLocal(val){
        if(!val) return null;
        // val like '2025-11-18T10:00'
        return val.replace('T',' ');
      }

      function renderExisting(){
        existingGrid.innerHTML = '';
        const kept = existing.filter(x=> !deletedIds.has(x.id));
        if (!kept.length){ existingGrid.innerHTML = '<div class="text-gray-500 dark:text-gray-400">No photos</div>'; return; }
        kept.forEach((imgObj, idx)=>{
          const card = document.createElement('div'); card.className='relative rounded-lg overflow-hidden ring-1 ring-black/5 bg-white dark:bg-gray-800';
          const el = document.createElement('img'); el.src = imgUrl(imgObj.id); el.className='thumb w-full'; el.alt = imgObj.image_name || '';
          const bar = document.createElement('div'); bar.className='absolute inset-x-0 bottom-0 p-2 text-xs bg-gradient-to-t from-black/60 to-transparent text-white flex items-center justify-between';
          const name = document.createElement('span'); name.textContent = imgObj.image_name || `img-${imgObj.id}`; name.className='truncate max-w-[60%]';

          const right = document.createElement('div'); right.className='flex gap-2';
          const setCover = document.createElement('button'); setCover.textContent='Set cover'; setCover.className='px-2 py-1 rounded-md bg-white/90 text-xs'; 
          setCover.addEventListener('click', async ()=>{
            // find index of this image in current gallery order as returned by backend
            try {
              const res = await fetch(API_BASE + '/events/' + id, { credentials:'include' });
              const json = await res.json();
              if (!res.ok) throw new Error(json && (json.error||json.message) || 'Failed');
              const imgs = Array.isArray(json.images) ? json.images : (Array.isArray(json.data) ? json.data : []);
              const idxInOrder = imgs.findIndex(i => Number(i.id) === Number(imgObj.id));
              if (idxInOrder < 0) throw new Error('Image not found in gallery');
              const fd = new FormData();
              fd.append('coverIndex', String(idxInOrder));
              const upd = await fetch(API_BASE + '/events/' + id, { method:'PUT', body: fd, credentials:'include' });
              const j2 = await upd.json().catch(()=>null);
              if (!upd.ok) throw new Error((j2 && (j2.error||j2.message)) || 'Failed to set cover');
              show('Cover updated');
              await load(); // refresh to reflect cover
            } catch (e){ console.error(e); show(e.message || 'Failed to set cover','error'); }
          });

          const rm = document.createElement('button'); rm.textContent='Remove'; rm.className='px-2 py-1 rounded-md bg-white/90 text-xs text-red-600';
          rm.addEventListener('click', ()=>{ deletedIds.add(imgObj.id); renderExisting(); });

          right.appendChild(setCover);
          right.appendChild(rm);
          bar.appendChild(name);
          bar.appendChild(right);
          card.appendChild(el);
          card.appendChild(bar);
          existingGrid.appendChild(card);
        });
      }

      function renderNewPreview(){
        newPreview.innerHTML = '';
        newFiles.forEach((f, idx)=>{
          const card = document.createElement('div'); card.className='relative rounded-lg overflow-hidden ring-1 ring-black/5 bg-white dark:bg-gray-800';
          const img = document.createElement('img'); img.src = URL.createObjectURL(f); img.className='thumb w-full'; img.alt = f.name;
          const rm = document.createElement('button'); rm.textContent='Remove'; rm.className='absolute top-2 right-2 px-2 py-1 rounded-md bg-white/90 text-xs'; 
          rm.addEventListener('click', ()=>{ newFiles.splice(idx,1); renderNewPreview(); });
          card.appendChild(img); card.appendChild(rm); newPreview.appendChild(card);
        });
      }

      function addFiles(list){
        const arr = Array.from(list || []);
        for (const f of arr){
          if (!f.type.startsWith('image/')) continue;
          newFiles.push(f);
        }
        renderNewPreview();
      }

      imagesInput.addEventListener('change', e=> addFiles(e.target.files));
      dropzone.addEventListener('drop', e=>{ e.preventDefault(); addFiles(e.dataTransfer.files); dropzone.classList.remove('dropzone-active'); });
      ['dragenter','dragover'].forEach(ev=> dropzone.addEventListener(ev, e=>{ e.preventDefault(); dropzone.classList.add('dropzone-active'); }));
      ['dragleave','drop','dragend'].forEach(ev=> dropzone.addEventListener(ev, e=>{ e.preventDefault(); dropzone.classList.remove('dropzone-active'); }));

      async function load(){
        if (!id){ 
          window.Notify?.error('Missing event ID', 3000);
          show('Missing id','error'); 
          return; 
        }
        window.Notify?.showLoading('Loading event...');
        viewLink.href = './view.html?id=' + encodeURIComponent(id);
        try {
          const res = await fetch(API_BASE + '/events/' + id, { credentials:'include' });
          const json = await res.json().catch(()=>null);
          if (!res.ok) throw new Error((json && (json.error||json.message)) || `HTTP ${res.status}`);
          const ev = json.event || json.data || json;
          const imgs = Array.isArray(json.images) ? json.images : (Array.isArray(ev.images) ? ev.images : []);

          eventIdFld.value = ev.id ?? id;
          title.value = ev.title || '';
          eventDate.value = ev.event_date ? toDateTimeLocal(ev.event_date) : '';
          hostedBy.value = ev.hosted_by || ev.host || '';
          link.value = ev.link || '';
          address.value = ev.address || '';
          description.value = ev.description || '';
          isPublished.checked = !!(ev.status === 1 || ev.status === '1' || ev.is_published === 1);

          existing = imgs.map(i => ({ id: Number(i.id), image_name: i.image_name || i.filename || '' }));
          deletedIds.clear(); newFiles = [];
          renderExisting(); renderNewPreview();
          window.Notify?.hideLoading();
        } catch (err){ 
          console.error(err); 
          window.Notify?.hideLoading();
          window.Notify?.error(err.message || 'Failed to load event', 5000);
          show(err.message || 'Load failed','error'); 
        }
      }

      resetBtn.addEventListener('click', load);

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!id){ 
          window.Notify?.error('Missing event ID', 3000);
          show('Missing id','error'); 
          return; 
        }
        const restoreBtn = window.Notify?.showButtonLoading(saveBtn, 'Saving...') || (() => {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save changes';
        });
        try {
          const fd = new FormData();
          fd.append('title', title.value.trim());
          if (eventDate.value) fd.append('event_date', fromDateTimeLocal(eventDate.value));
          fd.append('hosted_by', hostedBy.value || '');
          fd.append('link', link.value || '');
          fd.append('address', address.value || '');
          fd.append('description', description.value || '');
          fd.append('status', isPublished.checked ? '1' : '0');

          if (deletedIds.size) fd.append('deleteImageIds', Array.from(deletedIds).join(','));
          newFiles.forEach(f => fd.append('images[]', f, f.name));

          // PUT multipart to update endpoint
          const res = await fetch(API_BASE + '/events/' + id, { method:'PUT', body: fd, credentials:'include' });
          const json = await res.json().catch(()=>null);
          if (!res.ok) throw new Error((json && (json.error||json.message)) || `Update failed (${res.status})`);
          window.Notify?.success('Event updated successfully!', 3000);
          show('Saved', 'info', 1400);
          await load();
        } catch (err){ 
          console.error(err); 
          window.Notify?.error(err.message || 'Failed to update event', 5000);
          show(err.message || 'Save failed','error'); 
        }
        finally { restoreBtn(); }
      });

      deleteBtn.addEventListener('click', async ()=>{
        if (!confirm('Delete this event? This cannot be undone.')) return;
        const restoreBtn = window.Notify?.showButtonLoading(deleteBtn, 'Deleting...') || (() => {
          deleteBtn.disabled = false;
        });
        try {
          const r = await fetch(API_BASE + '/events/' + id, { method:'DELETE', credentials:'include' });
          const j = await r.json().catch(()=>null);
          if (!r.ok) throw new Error((j && (j.error || j.message)) || 'Delete failed');
          window.Notify?.success('Event deleted successfully! Redirecting...', 2000);
          setTimeout(() => location.href = './', 1000);
        } catch (e){ 
          console.error(e); 
          window.Notify?.error(e.message || 'Failed to delete event', 5000);
          show(e.message || 'Delete failed','error'); 
        } finally {
          restoreBtn();
        }
      });

      load();
    })();
  </script>
</body>
</html>

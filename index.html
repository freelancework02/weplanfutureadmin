<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin | Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="./assets/css/custom.css" />
</head>
<body class="h-full bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
  <!-- Backdrop -->
  <div id="backdrop" class="fixed inset-0 bg-black/40 opacity-0 pointer-events-none lg:hidden"></div>

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed top-0 left-0 z-40 h-full w-72 bg-white border-r border-gray-200 dark:bg-gray-800 dark:border-gray-700">
    <div class="flex items-center gap-3 px-5 h-16 border-b border-gray-200 dark:border-gray-700">
      <div class="size-9 rounded-lg bg-emerald-600"></div>
      <div class="font-semibold">Admin Panel</div>
    </div>
    <nav class="p-3">
      <a href="./index.html" class="flex items-center gap-3 px-3 py-2 rounded-lg bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">
        <span>üè†</span><span>Dashboard</span>
      </a>
      <a href="./events/" class="flex items-center gap-3 px-3 py-2 rounded-lg mt-1 hover:bg-gray-100 dark:hover:bg-gray-700">
        <span>üìÖ</span><span>Events</span>
      </a>
      <a href="./gallery/" class="flex items-center gap-3 px-3 py-2 rounded-lg mt-1 hover:bg-gray-100 dark:hover:bg-gray-700">
        <span>üñºÔ∏è</span><span>Gallery</span>
      </a>
      <a href="./blogs/" class="flex items-center gap-3 px-3 py-2 rounded-lg mt-1 hover:bg-gray-100 dark:hover:bg-gray-700">
        <span>üìù</span><span>Blogs</span>
      </a>
    </nav>
  </aside>

  <!-- Main -->
  <div class="lg:pl-72 min-h-full">
    <!-- Topbar -->
    <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-gray-200 dark:bg-gray-800/80 dark:border-gray-700">
      <div class="h-16 px-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <button class="lg:hidden p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="Open sidebar" data-toggle="sidebar">‚ò∞</button>
          <h1 class="text-lg font-semibold">Dashboard</h1>
        </div>
        <div class="flex items-center gap-2">
          <button id="themeToggle" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700" data-toggle="theme" aria-label="Toggle theme">üåì</button>
          <img src="./assets/img/avatar.png" alt="User" class="size-8 rounded-full ring-1 ring-black/5" />
        </div>
      </div>
    </header>

    <main class="p-6 space-y-6">
      <!-- Stat Cards -->
      <section class="grid gap-4 sm:grid-cols-2 xl:grid-cols-4">
        <div class="rounded-xl border border-gray-200 bg-white p-5 dark:bg-gray-800 dark:border-gray-700">
          <div class="flex items-center justify-between text-sm text-gray-500">
            <span>Total Events</span>
            <span class="size-11 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center dark:bg-emerald-900/20 dark:text-emerald-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10m-11 8h12a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-3M9 5H5a2 2 0 0 0-2 2v10c0 1.1.9 2 2 2h1"/>
              </svg>
            </span>
          </div>
          <div id="count-events" class="mt-3 text-3xl font-bold">‚Äî</div>
          <div id="events-delta" class="mt-1 text-xs text-emerald-600">‚Äî</div>
        </div>
        <div class="rounded-xl border border-gray-200 bg-white p-5 dark:bg-gray-800 dark:border-gray-700">
          <div class="flex items-center justify-between text-sm text-gray-500">
            <span>Gallery Items</span>
            <span class="size-11 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center dark:bg-indigo-900/20 dark:text-indigo-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 11l2.3 2.3a1 1 0 0 0 1.4 0L16 11l4 4V7" />
                <circle cx="7.5" cy="9.5" r="1.25" />
              </svg>
            </span>
          </div>
          <div id="count-galleries" class="mt-3 text-3xl font-bold">‚Äî</div>
          <div id="galleries-delta" class="mt-1 text-xs text-emerald-600">‚Äî</div>
        </div>
        <div class="rounded-xl border border-gray-200 bg-white p-5 dark:bg-gray-800 dark:border-gray-700">
          <div class="flex items-center justify-between text-sm text-gray-500">
            <span>Blog Posts</span>
            <span class="size-11 rounded-xl bg-amber-50 text-amber-600 flex items-center justify-center dark:bg-amber-900/20 dark:text-amber-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 20H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h6" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4h6v16h-6m0-11h4m-4 4h4m-4 4h4" />
              </svg>
            </span>
          </div>
          <div id="count-blogs" class="mt-3 text-3xl font-bold">‚Äî</div>
          <div id="blogs-delta" class="mt-1 text-xs text-amber-600">‚Äî</div>
        </div>
        <div class="rounded-xl border border-gray-200 bg-white p-5 dark:bg-gray-800 dark:border-gray-700">
          <div class="flex items-center justify-between text-sm text-gray-500">
            <span>Subscribers</span>
            <span class="size-11 rounded-xl bg-sky-50 text-sky-600 flex items-center justify-center dark:bg-sky-900/20 dark:text-sky-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="3" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 19v-2a3 3 0 0 0-2.4-2.9M17 5a3 3 0 0 1 0 5.9" />
              </svg>
            </span>
          </div>
          <div id="count-subscribers" class="mt-3 text-3xl font-bold">‚Äî</div>
          <div id="subs-delta" class="mt-1 text-xs text-emerald-600">‚Äî</div>
        </div>
      </section>

      <!-- Activity + Quick Actions -->
      <section class="grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 rounded-xl border border-gray-200 bg-white p-5 dark:bg-gray-800 dark:border-gray-700">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">Recent Activity</h2>
            <!-- <button id="viewAllBtn" class="text-sm px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600">View all</button> -->
          </div>

          <div class="mt-4 space-y-3">
            <!-- container for dynamic activities -->
            <div id="recent-activity" class="space-y-3">
              <div class="text-sm text-gray-500">Loading recent items‚Ä¶</div>
            </div>
          </div>
        </div>

        <div class="rounded-xl border border-gray-200 bg-white p-5 dark:bg-gray-800 dark:border-gray-700">
          <h2 class="font-semibold">Quick Actions</h2>
          <div class="mt-4 grid gap-3">
            <a href="./events/AddEvents.html" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" />
              </svg>
              Create Event
            </a>
            <a href="./gallery/add.html" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 11l2 2 3-3 3 3" />
              </svg>
              Add Gallery
            </a>
            <a href="./blogs/add.html" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-amber-600 text-white hover:bg-amber-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 20H7a2 2 0 0 1-2-2V6c0-1.1.9-2 2-2h7" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M16 4h1a2 2 0 0 1 2 2v11l-3-2-3 2V4" />
              </svg>
              Write Blog
            </a>
          </div>
        </div>
      </section>

      <!-- Info Alert -->
      <div id="dashboard-alert" class="rounded-xl border border-emerald-200 bg-emerald-50 p-4 text-emerald-900 flex items-start gap-3 dark:bg-emerald-900/20 dark:text-emerald-100 dark:border-emerald-900/40" role="alert" style="display:none;">
        <span>‚ÑπÔ∏è</span>
        <div class="flex-1">
          <div id="alert-title" class="font-medium">Heads up</div>
          <div id="alert-msg" class="text-sm">This is a live dashboard.</div>
        </div>
        <button id="alert-close" class="text-emerald-900/70 hover:text-emerald-900" aria-label="Close">‚úï</button>
      </div>
    </main>
  </div>

  <script>
    (function(){
      // helper formatters
      const apiBase = 'https://weplanfuture.com/api/dashboard';
      const qs = new URLSearchParams(location.search);
      const limit = qs.get('limit') || 5;

      function fmtDate(v){
        if(!v) return '‚Äî';
        try {
          return new Date(String(v).replace(' ', 'T')).toLocaleString();
        } catch(e) { return v; }
      }

      function showAlert(title, msg){
        const wrap = document.getElementById('dashboard-alert');
        document.getElementById('alert-title').textContent = title || 'Notice';
        document.getElementById('alert-msg').textContent = msg || '';
        wrap.style.display = 'flex';
      }
      document.getElementById('alert-close').addEventListener('click', ()=> {
        document.getElementById('dashboard-alert').style.display = 'none';
      });

      async function fetchJson(url){
        const res = await fetch(url, { credentials: 'include' });
        const json = await res.json().catch(()=>null);
        if (!res.ok) {
          const message = (json && (json.error || json.message)) || `HTTP ${res.status}`;
          const err = new Error(message);
          err.payload = json;
          throw err;
        }
        return json;
      }

      function renderCounts(counts){
        document.getElementById('count-events').textContent = counts.events ?? 0;
        document.getElementById('count-galleries').textContent = counts.galleries ?? 0;
        document.getElementById('count-blogs').textContent = counts.blogs ?? 0;
        document.getElementById('count-subscribers').textContent = counts.subscribers ?? 0;
      }

      function makeActivityItem(kind, item){
        // build a simple DOM node describing the item
        const container = document.createElement('div');
        container.className = 'flex items-start gap-3';

        const icon = document.createElement('div');
        icon.className = 'text-xl';
        icon.textContent = kind === 'event' ? 'üìÖ' : (kind === 'blog' ? 'üìù' : 'üì∑');

        const body = document.createElement('div');
        const title = document.createElement('div');
        title.className = 'font-medium';
        let titleText = item.title || item.name || `#${item.id}`;
        title.textContent = `${titleText}`;

        const meta = document.createElement('div');
        meta.className = 'text-xs text-gray-500';
        if (kind === 'event') {
          meta.textContent = `Event date: ${item.event_date ? fmtDate(item.event_date) : '‚Äî'} ‚Ä¢ Created: ${fmtDate(item.created_at)}`;
        } else if (kind === 'blog') {
          meta.textContent = `Created: ${fmtDate(item.created_at)}${item.is_published ? ' ‚Ä¢ Published' : ''}`;
        } else {
          meta.textContent = `Created: ${fmtDate(item.created_at)}`;
        }

        // actions: view / edit links
        const actions = document.createElement('div');
        actions.className = 'mt-1 flex gap-2';
        const viewA = document.createElement('a');
        viewA.className = 'text-xs px-2 py-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700';
        viewA.href = kind === 'event' ? `./events/view.html?id=${encodeURIComponent(item.id)}` :
                  kind === 'blog' ? `./blogs/view.html?id=${encodeURIComponent(item.id)}` :
                  `./gallery/view.html?id=${encodeURIComponent(item.id)}`;
        viewA.textContent = 'View';

        const editA = document.createElement('a');
        editA.className = 'text-xs px-2 py-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700';
        editA.href = kind === 'event' ? `./events/edit.html?id=${encodeURIComponent(item.id)}` :
                  kind === 'blog' ? `./blogs/edit.html?id=${encodeURIComponent(item.id)}` :
                  `./gallery/edit.html?id=${encodeURIComponent(item.id)}`;
        editA.textContent = 'Edit';

        actions.appendChild(viewA);
        actions.appendChild(editA);

        body.appendChild(title);
        body.appendChild(meta);
        body.appendChild(actions);

        container.appendChild(icon);
        container.appendChild(body);
        return container;
      }

      async function renderDashboard(){
        const recentContainer = document.getElementById('recent-activity');
        recentContainer.innerHTML = '<div class="text-sm text-gray-500">Loading recent items‚Ä¶</div>';

        try {
          // primary combined endpoint
          const resp = await fetchJson(`${apiBase}?limit=${encodeURIComponent(limit)}`);
          if (resp && resp.ok) {
            // counts
            if (resp.counts) renderCounts(resp.counts);

            // latest: expected shape { latest: { events:[], blogs:[], galleries:[] } }
            const latest = resp.latest || {};
            const items = [];

            // prefer interleaving: events -> blogs -> galleries up to limit each, then flatten
            (latest.events || []).slice(0, limit).forEach(i => items.push({ kind: 'event', item: i }));
            (latest.blogs || []).slice(0, limit).forEach(i => items.push({ kind: 'blog', item: i }));
            (latest.galleries || []).slice(0, limit).forEach(i => items.push({ kind: 'gallery', item: i }));

            if (!items.length) {
              recentContainer.innerHTML = '<div class="text-sm text-gray-500">No recent activity.</div>';
            } else {
              recentContainer.innerHTML = '';
              items.slice(0, 10).forEach(({kind, item}) => {
                recentContainer.appendChild(makeActivityItem(kind, item));
              });
            }

            // hide alert if everything ok
            document.getElementById('dashboard-alert').style.display = 'none';
            return;
          }

          // fallback: counts only maybe
          throw new Error('Invalid dashboard response');
        } catch (err) {
          console.warn('dashboard main fetch failed:', err.message);
          // fallback to counts endpoint
          try {
            const cnt = await fetchJson(`${apiBase}/counts`);
            if (cnt && cnt.ok && cnt.counts) {
              renderCounts(cnt.counts);
              showAlert('Partial data', 'Latest items are unavailable ‚Äî showing counts only.');
              document.getElementById('recent-activity').innerHTML = '<div class="text-sm text-gray-500">Latest items unavailable.</div>';
              return;
            }
          } catch (err2) {
            console.error('dashboard counts fallback failed', err2);
          }

          // ultimate fallback: show error
          renderCounts({ events: '‚Äî', galleries: '‚Äî', blogs: '‚Äî', subscribers: '‚Äî' });
          showAlert('Unable to fetch dashboard data', err.message || 'Server error');
          document.getElementById('recent-activity').innerHTML = `<div class="text-sm text-red-600">Failed to load recent items.</div>`;
        }
      }

      // initialize theme toggle like older pages
      (function baseUI(){
        document.querySelectorAll('[data-toggle="sidebar"]').forEach(btn=>{
          btn.addEventListener('click',()=>document.documentElement.classList.toggle('sidebar-open'));
        });
        const themeBtn = document.getElementById('themeToggle');
        const setTheme = t => { document.documentElement.classList.toggle('dark', t==='dark'); localStorage.setItem('theme', t); };
        themeBtn?.addEventListener('click', ()=> setTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark'));
        const stored = localStorage.getItem('theme'); if (stored) setTheme(stored);
      })();

      // wire view all -> dashboard/latest?
      // document.getElementById('viewAllBtn').addEventListener('click', ()=> {
      //   // open dashboard's latest endpoint in a new tab for inspection (or route to an Activity page)
      //   window.open(`/api/dashboard/latest?limit=20`, '_blank');
      // });

      renderDashboard();
    })();
  </script>
</body>
</html>

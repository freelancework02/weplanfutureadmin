<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin | Blogs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../assets/css/custom.css" />
  <script src="../assets/js/notifications.js"></script>
  <style>
    #alert { max-width: 1100px; margin: 0 auto 12px; }
    .action-btn { padding: 6px 8px; border-radius: 6px; }
    .icon { font-size: 14px; line-height: 1; }
  </style>
</head>
<body class="h-full bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
  <div id="backdrop" class="fixed inset-0 bg-black/40 opacity-0 pointer-events-none lg:hidden"></div>

  <aside id="sidebar" class="fixed top-0 left-0 z-40 h-full w-72 bg-white border-r border-gray-200 dark:bg-gray-800 dark:border-gray-700">
    <div class="flex items-center gap-3 px-5 h-16 border-b border-gray-200 dark:border-gray-700">
      <div class="size-9 rounded-lg bg-emerald-600"></div>
      <div class="font-semibold">Admin Panel</div>
    </div>
    <nav class="p-3">
      <a href="../index.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
        <span>üè†</span><span>Dashboard</span>
      </a>
      <a href="../events/" class="flex items-center gap-3 px-3 py-2 rounded-lg mt-1 hover:bg-gray-100 dark:hover:bg-gray-700">
        <span>üìÖ</span><span>Events</span>
      </a>
      <a href="../gallery/" class="flex items-center gap-3 px-3 py-2 rounded-lg mt-1 hover:bg-gray-100 dark:hover:bg-gray-700">
        <span>üñºÔ∏è</span><span>Gallery</span>
      </a>
      <a href="./" class="flex items-center gap-3 px-3 py-2 rounded-lg mt-1 bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">
        <span>üìù</span><span>Blogs</span>
      </a>
    </nav>
  </aside>

  <div class="lg:pl-72 min-h-full">
    <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-gray-200 dark:bg-gray-800/80 dark:border-gray-700">
      <div class="h-16 px-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <button class="lg:hidden p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700" data-toggle="sidebar">‚ò∞</button>
          <h1 class="text-lg font-semibold">Blogs</h1>
        </div>
        <div class="flex items-center gap-2">
          <button class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700" data-toggle="theme">üåì</button>
          <a href="./add.html" class="px-3 py-1.5 rounded-lg bg-amber-600 text-white hover:bg-amber-700">+ New Post</a>
        </div>
      </div>
    </header>

    <main class="p-6 space-y-6" data-api-base="https://weplanfuture.com/api">
      <!-- small alert -->
      <div id="alert" class="hidden rounded-lg border p-3 text-sm"></div>

      <!-- Toolbar -->
      <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
        <input id="search" type="text" placeholder="Search posts‚Ä¶" class="w-full sm:w-80 px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-amber-500 dark:bg-gray-800 dark:border-gray-700" />
        <div class="text-sm text-gray-500">Showing <b id="totalCount">0</b> posts</div>
      </div>

      <div class="overflow-x-auto rounded-xl border border-gray-200 bg-white dark:bg-gray-800 dark:border-gray-700">
        <table id="blogs-table" class="min-w-full text-sm">
          <thead class="bg-gray-50 text-gray-600 dark:bg-gray-700 dark:text-gray-300">
            <tr>
              <th class="px-4 py-3 text-left font-medium">Title</th>
              <th class="px-4 py-3 text-left font-medium">Author</th>
              <th class="px-4 py-3 text-left font-medium">Published</th>
              <th class="px-4 py-3 text-left font-medium">Status</th>
              <th class="px-4 py-3 text-right font-medium">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
            <!-- injected -->
          </tbody>
        </table>

        <div id="empty" class="hidden p-10 text-center text-gray-500 dark:text-gray-400">
          No posts yet. Click <b>+ New Post</b> to create one.
        </div>
      </div>
    </main>
  </div>

  <script>
    (function baseUI(){
      document.querySelectorAll('[data-toggle="sidebar"]').forEach(btn=>{
        btn.addEventListener('click',()=>document.documentElement.classList.toggle('sidebar-open'));
      });
      const themeBtn = document.querySelector('[data-toggle="theme"]');
      const setTheme = t => { document.documentElement.classList.toggle('dark', t==='dark'); localStorage.setItem('theme', t); };
      if (themeBtn) themeBtn.addEventListener('click',()=>setTheme(document.documentElement.classList.contains('dark')?'light':'dark'));
      const stored = localStorage.getItem('theme'); if (stored) setTheme(stored);
    })();

    (function blogsList(){
      const apiBase = document.querySelector('main').getAttribute('data-api-base') || '/api';
      const LIST_URL = `${apiBase}/blogs?page=1&per=200`;   // backend should accept pagination
      const DELETE_URL = id => `${apiBase}/blogs/${encodeURIComponent(id)}`;

      const tbody = document.getElementById('tbody');
      const empty = document.getElementById('empty');
      const totalCount = document.getElementById('totalCount');
      const search = document.getElementById('search');
      const alertBox = document.getElementById('alert');

      let items = [];
      let filtered = [];

      const showAlert = (msg, type='info', ttl=2500) => {
        alertBox.className = 'rounded-lg border p-3 text-sm mx-auto ' + (
          type === 'error'
            ? 'border-red-200 bg-red-50 text-red-800 dark:border-red-900/40 dark:bg-red-900/20 dark:text-red-100'
            : 'border-emerald-200 bg-emerald-50 text-emerald-800 dark:border-emerald-900/40 dark:bg-emerald-900/20 dark:text-emerald-100'
        );
        alertBox.textContent = msg;
        alertBox.classList.remove('hidden');
        if (ttl) setTimeout(()=> alertBox.classList.add('hidden'), ttl);
      };

      const timeFmt = (iso) => {
        if (!iso) return '‚Äî';
        try { return new Date(String(iso).replace(' ', 'T')).toLocaleDateString(); } catch(e) { return iso; }
      };

      const render = () => {
        tbody.innerHTML = '';
        if (!filtered.length) {
          empty.classList.remove('hidden');
          totalCount.textContent = '0';
          return;
        }
        empty.classList.add('hidden');
        totalCount.textContent = String(filtered.length);

        for (const b of filtered) {
          const tr = document.createElement('tr');

          // Title
          const titleTd = document.createElement('td');
          titleTd.className = 'px-4 py-3';
          const titleDiv = document.createElement('div');
          titleDiv.className = 'font-medium';
          titleDiv.textContent = b.title || `Post ${b.id}`;
          const excerpt = document.createElement('div');
          excerpt.className = 'text-xs text-gray-500';
          excerpt.textContent = (b.excerpt ?? b.description ?? '').slice(0, 120);
          titleTd.appendChild(titleDiv); titleTd.appendChild(excerpt);

          // Author
          const authorTd = document.createElement('td');
          authorTd.className = 'px-4 py-3';
          authorTd.textContent = b.author || (b.createdBy || 'Admin');

          // Published / date
          const pubTd = document.createElement('td');
          pubTd.className = 'px-4 py-3';
          pubTd.textContent = timeFmt(b.publishedAt ?? b.created_at ?? b.createdAt);

          // Status
          const statusTd = document.createElement('td');
          statusTd.className = 'px-4 py-3';
          const status = (b.is_published ?? b.isPublished) ? 'Published' : 'Draft';
          const span = document.createElement('span');
          span.className = `px-2 py-1 rounded-full text-xs ${status === 'Published' ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300' : 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300'}`;
          span.textContent = status;
          statusTd.appendChild(span);

          // Actions
          const actionsTd = document.createElement('td');
          actionsTd.className = 'px-4 py-3';
          const wrap = document.createElement('div');
          wrap.className = 'flex items-center gap-1 justify-end';

          // View button -> navigates to view.html?id=...
          const viewBtn = document.createElement('button');
          viewBtn.className = 'action-btn bg-gray-50 hover:bg-gray-100 dark:bg-gray-800 dark:hover:bg-gray-700';
          viewBtn.title = 'View';
          viewBtn.innerHTML = '<span class="icon">View</span>';
          viewBtn.addEventListener('click', ()=> {
            window.location.href = `./view.html?id=${encodeURIComponent(b.id)}`;
          });

          // Edit button -> navigates to edit.html?id=...
          const editBtn = document.createElement('button');
          editBtn.className = 'action-btn bg-gray-50 hover:bg-gray-100 dark:bg-gray-800 dark:hover:bg-gray-700';
          editBtn.title = 'Edit';
          editBtn.innerHTML = '<span class="icon">Edit</span>';
          editBtn.addEventListener('click', ()=> {
            window.location.href = `./edit.html?id=${encodeURIComponent(b.id)}`;
          });

          // Delete button -> calls DELETE
          const delBtn = document.createElement('button');
          delBtn.className = 'action-btn text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20';
          delBtn.title = 'Delete';
          delBtn.innerHTML = '<span class="icon">Delete</span>';
          delBtn.addEventListener('click', async () => {
            const ok = confirm(`Delete post "${b.title}"? This cannot be undone.`);
            if (!ok) return;
            const loader = window.Notify?.showLoader('Deleting blog post...');
            try {
              const res = await fetch(DELETE_URL(b.id), { method: 'DELETE', credentials: 'include' });
              const json = await res.json().catch(()=>null);
              if (!res.ok) throw new Error((json && (json.error||json.message)) || `Delete failed (${res.status})`);
              // remove from items & re-render
              items = items.filter(x => Number(x.id) !== Number(b.id));
              filtered = filtered.filter(x => Number(x.id) !== Number(b.id));
              render();
              window.Notify?.hideLoader();
              window.Notify?.success('Blog post deleted successfully', 3000);
              showAlert('Post deleted', 'info');
            } catch (err) {
              console.error('Delete error', err);
              window.Notify?.hideLoader();
              window.Notify?.error(err.message || 'Failed to delete blog post', 5000);
              showAlert(err.message || 'Delete failed', 'error');
            }
          });

          wrap.appendChild(viewBtn);
          wrap.appendChild(editBtn);
          wrap.appendChild(delBtn);
          actionsTd.appendChild(wrap);

          tr.appendChild(titleTd);
          tr.appendChild(authorTd);
          tr.appendChild(pubTd);
          tr.appendChild(statusTd);
          tr.appendChild(actionsTd);
          tbody.appendChild(tr);
        }
      };

      const load = async () => {
        window.Notify?.showLoading('Loading blog posts...');
        try {
          const res = await fetch(LIST_URL, { credentials: 'include' });
          const json = await res.json().catch(()=>null);
          if (!res.ok) {
            throw new Error((json && (json.error||json.message)) || `Failed to load (${res.status})`);
          }

          // accept shapes: { data: [...] }, { items: [...] }, or array
          const rows = Array.isArray(json.data) ? json.data : (Array.isArray(json.items) ? json.items : (Array.isArray(json) ? json : []));
          items = rows.map(r => ({
            id: r.id,
            title: r.title,
            description: r.description || r.excerpt || '',
            excerpt: r.excerpt || '',
            author: r.author || r.createdBy || 'Admin',
            created_at: r.created_at,
            createdAt: r.createdAt,
            publishedAt: r.published_at || r.publishedAt || null,
            is_published: r.is_published ?? r.isPublished ?? false,
            images_count: r.images_count ?? r.imagesCount ?? 0
          }));
          filtered = [...items];
          render();
          window.Notify?.hideLoading();
          if (items.length > 0) {
            window.Notify?.success(`Loaded ${items.length} blog post${items.length === 1 ? '' : 's'}`, 2000);
          }
        } catch (err) {
          console.error('Load error', err);
          items = [];
          filtered = [];
          render();
          window.Notify?.hideLoading();
          window.Notify?.error(err.message || 'Failed to load blog posts', 5000);
          showAlert(err.message || 'Failed to load posts', 'error', 4000);
        }
      };

      search.addEventListener('input', ()=> {
        const q = search.value.trim().toLowerCase();
        filtered = !q ? [...items] : items.filter(b =>
          String(b.title || '').toLowerCase().includes(q) ||
          String(b.description || '').toLowerCase().includes(q)
        );
        render();
      });

      // initial
      load();
    })();
  </script>
</body>
</html>

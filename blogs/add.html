<!DOCTYPE html>
<html lang="en" class="h-full" data-root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin | New Blog</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../assets/css/custom.css" />

  <!-- Quill (Snow theme) -->
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet" />
  <style>
    .thumb { aspect-ratio: 16 / 9; object-fit: cover; }
    .cover-ring { box-shadow: 0 0 0 2px rgba(16,185,129,.9) inset; }
    #editor { height: 320px; }
    .ql-toolbar.ql-snow { border-radius: 0.75rem 0.75rem 0 0; }
    .ql-container.ql-snow { border-radius: 0 0 0.75rem 0.75rem; }
    #toolbar.ql-toolbar .ql-stroke { stroke: #fff !important; }
    #toolbar.ql-toolbar .ql-fill { fill: #fff !important; }
    #toolbar.ql-toolbar .ql-picker, #toolbar.ql-toolbar .ql-picker-label, #toolbar.ql-toolbar .ql-picker-item, #toolbar.ql-toolbar .ql-formats button { color: #fff !important; }
    #toolbar.ql-toolbar .ql-picker-options { background: #111827 !important; border-color: #374151 !important; color: #fff !important; }
    #toolbar.ql-toolbar .ql-picker-label:hover, #toolbar.ql-toolbar .ql-picker-item:hover, #toolbar.ql-toolbar .ql-formats button:hover, #toolbar.ql-toolbar .ql-formats .ql-active { filter: brightness(1.15); }
    #formAlert { max-width: 900px; margin: 0 auto; }
    pre#debugResp { max-height: 220px; overflow:auto; font-size:12px; background:#0f172a; color:#e6eef8; padding:8px; border-radius:6px; }
  </style>
</head>
<body class="h-full bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
  <div id="backdrop" class="fixed inset-0 bg-black/40 opacity-0 pointer-events-none lg:hidden"></div>
  <aside id="sidebar" class="fixed top-0 left-0 z-40 h-full w-72 bg-white border-r border-gray-200 dark:bg-gray-800 dark:border-gray-700">
    <div class="flex items-center gap-3 px-5 h-16 border-b border-gray-200 dark:border-gray-700">
      <div class="size-9 rounded-lg bg-emerald-600"></div>
      <div class="font-semibold">Admin Panel</div>
    </div>
    <nav class="p-3">
      <a href="../index.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
        <span>üè†</span><span>Dashboard</span>
      </a>
      <a href="../events/" class="flex items-center gap-3 px-3 py-2 rounded-lg mt-1 hover:bg-gray-100 dark:hover:bg-gray-700">
        <span>üìÖ</span><span>Events</span>
      </a>
      <a href="../gallery/" class="flex items-center gap-3 px-3 py-2 rounded-lg mt-1 hover:bg-gray-100 dark:hover:bg-gray-700">
        <span>üñºÔ∏è</span><span>Gallery</span>
      </a>
      <a href="./" class="flex items-center gap-3 px-3 py-2 rounded-lg mt-1 bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">
        <span>üìù</span><span>Blogs</span>
      </a>
    </nav>
  </aside>

  <div class="lg:pl-72 min-h-full">
    <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-gray-200 dark:bg-gray-800/80 dark:border-gray-700">
      <div class="h-16 px-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button class="lg:hidden p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700" data-toggle="sidebar" aria-label="Open sidebar">‚ò∞</button>
          <div>
            <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Blogs</p>
            <h1 class="text-lg font-semibold">Create Blog Post</h1>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700" data-toggle="theme" aria-label="Toggle theme">üåì</button>
          <a href="./" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-100 dark:border-gray-700 dark:text-gray-200 dark:hover:bg-gray-700">
            ‚Üê Back to Blogs
          </a>
        </div>
      </div>
    </header>

    <main class="p-6">
      <!-- IMPORTANT: set the API endpoint here to your express route -->
      <form id="blogForm"
            class="max-w-4xl mx-auto space-y-6 bg-white rounded-2xl border border-gray-200 p-6 shadow-sm dark:bg-gray-800 dark:border-gray-700"
            method="POST" enctype="multipart/form-data"
            data-endpoint="/api/blogs">

        <div>
          <label for="title" class="block text-sm font-medium mb-1">Title <span class="text-red-600">*</span></label>
          <input id="title" name="title" type="text" required
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 dark:bg-gray-900 dark:border-gray-700"
                 placeholder="e.g., How We Built Our New Gallery" />
        </div>

        <div>
          <div class="flex items-center justify-between mb-1">
            <label class="block text-sm font-medium">Content</label>
            <div class="text-xs text-gray-500 dark:text-gray-300">Words: <span id="wordCount">0</span></div>
          </div>

          <div id="toolbar" class="ql-toolbar ql-snow bg-gray-800 text-white rounded-t-xl"></div>
          <div id="editor" class="bg-white dark:bg-gray-900 rounded-b-xl"></div>

          <input type="hidden" id="content_html" name="content_html" />
          <input type="hidden" id="content_delta" name="content_delta" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Images (optional, up to 2)</label>
          <div class="flex items-center gap-3">
            <label for="images" class="inline-flex items-center px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 cursor-pointer">
              Choose files
            </label>
            <input id="images" name="images[]" type="file" multiple accept="image/*" class="hidden" />
            <p class="text-xs text-gray-500">Max 2 images, 5MB each. You can set one as cover.</p>
          </div>

          <div id="preview" class="mt-4 grid grid-cols-2 gap-4"></div>
          <input type="hidden" id="coverIndex" name="coverIndex" value="-1" />
        </div>

        <div class="flex items-center gap-3">
          <input id="isPublished" name="isPublished" type="checkbox" class="size-4" checked />
          <label for="isPublished" class="text-sm">Publish immediately</label>
        </div>

        <div class="flex items-center justify-between pt-2">
          <button type="button" id="clearBtn" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 dark:border-gray-700 dark:hover:bg-gray-700">
            Clear
          </button>
          <div class="flex items-center gap-2">
            <label class="text-xs text-gray-500 flex items-center gap-2">
              <input id="useAjax" type="checkbox" class="size-4" checked />
              Submit via fetch (AJAX)
            </label>
            <button id="submitBtn" type="submit"
                    class="px-5 py-2.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed">
              Save Post
            </button>
          </div>
        </div>

        <div id="formAlert" class="hidden mt-2 rounded-lg border p-3 text-sm"></div>

        <!-- Debug area: will show raw server response for debugging -->
        <div class="mt-3">
          <div class="text-xs text-gray-400">Server response (debug):</div>
          <pre id="debugResp" class="hidden"></pre>
        </div>
      </form>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>

  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/notifications.js"></script>
  <script>
    (function baseUI(){
      document.querySelectorAll('[data-toggle="sidebar"]').forEach(btn=>{
        btn.addEventListener('click',()=>document.documentElement.classList.toggle('sidebar-open'));
      });
      const themeBtn = document.querySelector('[data-toggle="theme"]');
      const setTheme = t => { document.documentElement.classList.toggle('dark', t==='dark'); localStorage.setItem('theme', t); };
      if (themeBtn) themeBtn.addEventListener('click',()=>setTheme(document.documentElement.classList.contains('dark')?'light':'dark'));
      const stored = localStorage.getItem('theme'); if (stored) setTheme(stored);
    })();

    (function buildToolbar(){
      const tb = document.getElementById('toolbar');
      tb.innerHTML = `
        <span class="ql-formats">
          <select class="ql-font"></select>
          <select class="ql-size"></select>
        </span>
        <span class="ql-formats">
          <button class="ql-bold"></button>
          <button class="ql-italic"></button>
          <button class="ql-underline"></button>
          <button class="ql-strike"></button>
        </span>
        <span class="ql-formats">
          <select class="ql-color"></select>
          <select class="ql-background"></select>
        </span>
        <span class="ql-formats">
          <button class="ql-script" value="sub"></button>
          <button class="ql-script" value="super"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-blockquote"></button>
          <button class="ql-code-block"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-list" value="ordered"></button>
          <button class="ql-list" value="bullet"></button>
          <select class="ql-align"></select>
          <button class="ql-direction" value="rtl"></button>
        </span>
        <span class="ql-formats">
          <select class="ql-header">
            <option selected></option>
            <option value="1"></option>
            <option value="2"></option>
            <option value="3"></option>
            <option value="4"></option>
            <option value="5"></option>
            <option value="6"></option>
          </select>
        </span>
        <span class="ql-formats">
          <button class="ql-link"></button>
          <button class="ql-clean"></button>
        </span>
      `;
    })();

    (function(){
      window.Auth?.requireAuth();

      const quill = new Quill('#editor', {
        theme: 'snow',
        modules: { toolbar: '#toolbar', clipboard: { matchVisual: false } },
        placeholder: 'Write your blog content here‚Ä¶'
      });

      const form = document.getElementById('blogForm');
      // const API_URL = form.getAttribute('data-endpoint') || form.action || '/api/blogs';
      const API_URL = 'https://weplanfuture.com/api/blogs';
      const title = document.getElementById('title');
      const isPublished = document.getElementById('isPublished');
      const contentHtml = document.getElementById('content_html');
      const contentDelta = document.getElementById('content_delta');
      const wordCountEl  = document.getElementById('wordCount');
      const input = document.getElementById('images');
      const preview = document.getElementById('preview');
      const coverIndexField = document.getElementById('coverIndex');
      const submitBtn = document.getElementById('submitBtn');
      const clearBtn = document.getElementById('clearBtn');
      const formAlert = document.getElementById('formAlert');
      const useAjax = document.getElementById('useAjax');
      const debugResp = document.getElementById('debugResp');

      const MAX_IMAGES = 2;
      const MAX_PER_FILE = 5 * 1024 * 1024; // 5MB
      let files = [];

      const showAlert = (msg, type='info', persistMs=4000) => {
        formAlert.className = 'mt-2 rounded-lg border p-3 text-sm ' +
          (type==='error'
            ? 'border-red-200 bg-red-50 text-red-800 dark:border-red-900/40 dark:bg-red-900/20 dark:text-red-100'
            : 'border-emerald-200 bg-emerald-50 text-emerald-800 dark:border-emerald-900/40 dark:bg-emerald-900/20 dark:text-emerald-100');
        formAlert.textContent = msg;
        formAlert.classList.remove('hidden');
        if (persistMs) setTimeout(()=>formAlert.classList.add('hidden'), persistMs);
      };

      const textFromHtml = (html) => {
        const div = document.createElement('div');
        div.innerHTML = html || '';
        return (div.textContent || '').replace(/\s+/g, ' ').trim();
      };

      const updateWordCount = () => {
        const html = quill.root.innerHTML;
        const txt = textFromHtml(html);
        const words = txt.length ? txt.split(/\s+/).length : 0;
        wordCountEl.textContent = words;
      };

      const validate = () => {
        if (!title.value.trim()) return false;
        const html = quill.root.innerHTML;
        const text = textFromHtml(html);
        if (!text.length) return false;
        if (files.some(f => f.size > MAX_PER_FILE)) return false;
        if (files.length > MAX_IMAGES) return false;
        return true;
      };

      const updateSubmitState = () => { submitBtn.disabled = !validate(); };

      const highlightCover = () => {
        [...preview.children].forEach((el, i) => {
          el.classList.toggle('cover-ring', i === Number(coverIndexField.value));
        });
      };

      const renderPreview = () => {
        preview.innerHTML = '';
        files.forEach((file, idx) => {
          const url = URL.createObjectURL(file);
          const card = document.createElement('div');
          card.className = 'relative group rounded-lg overflow-hidden ring-1 ring-black/5 bg-gray-50 dark:bg-gray-900';
          const img = document.createElement('img');
          img.src = url;
          img.alt = file.name;
          img.className = 'thumb w-full h-36';
          const rm = document.createElement('button');
          rm.type = 'button';
          rm.className = 'absolute top-2 right-2 px-2 py-1 text-xs rounded-md bg-white/90 hover:bg-white dark:bg-gray-800/90';
          rm.textContent = 'Remove';
          rm.addEventListener('click', () => {
            files.splice(idx, 1);
            if (Number(coverIndexField.value) === idx) {
              coverIndexField.value = files.length ? '0' : '-1';
            } else if (Number(coverIndexField.value) > idx) {
              coverIndexField.value = String(Number(coverIndexField.value) - 1);
            }
            renderPreview();
            updateSubmitState();
          });

          const bar = document.createElement('div');
          bar.className = 'absolute inset-x-0 bottom-0 p-2 text-xs bg-gradient-to-t from-black/50 to-transparent text-white flex items-center justify-between';
          const name = document.createElement('span');
          name.className = 'truncate max-w-[65%]';
          name.textContent = file.name;
          const coverBtn = document.createElement('button');
          coverBtn.type = 'button';
          coverBtn.className = 'px-2 py-1 rounded-md bg-white/90 text-gray-900 hover:bg-white';
          coverBtn.textContent = 'Set cover';
          coverBtn.addEventListener('click', () => {
            coverIndexField.value = String(idx);
            highlightCover();
          });

          bar.appendChild(name);
          bar.appendChild(coverBtn);
          card.appendChild(img);
          card.appendChild(rm);
          card.appendChild(bar);
          preview.appendChild(card);
        });
        highlightCover();
      };

      const addFiles = (list) => {
        const incoming = Array.from(list);
        for (const f of incoming) {
          if (!f.type.startsWith('image/')) continue;
          if (f.size > MAX_PER_FILE) { showAlert(`"${f.name}" is larger than 5MB (skipped).`, 'error'); continue; }
          if (files.length >= MAX_IMAGES) { showAlert(`Maximum ${MAX_IMAGES} images allowed.`, 'error'); break; }
          files.push(f);
        }
        renderPreview();
        updateSubmitState();
      };

      input.addEventListener('change', (e) => addFiles(e.target.files));
      quill.on('text-change', () => { updateWordCount(); updateSubmitState(); });
      title.addEventListener('input', updateSubmitState);

      clearBtn.addEventListener('click', () => {
        files = [];
        input.value = '';
        title.value = '';
        quill.setContents([]);
        coverIndexField.value = '-1';
        renderPreview();
        updateWordCount();
        updateSubmitState();
        showAlert('Cleared.', 'info', 1500);
        debugResp.classList.add('hidden');
      });

      const syncEditorHiddenFields = () => {
        contentHtml.value  = quill.root.innerHTML;
        try { contentDelta.value = JSON.stringify(quill.getContents()); } catch(e){ contentDelta.value = ''; }
      };

      const showDebugResponse = async (res) => {
        debugResp.classList.remove('hidden');
        let text = `HTTP ${res.status} ${res.statusText}\n\n`;
        try {
          const json = await res.clone().json().catch(()=>null);
          if (json) {
            text += JSON.stringify(json, null, 2);
          } else {
            const txt = await res.clone().text();
            text += txt;
          }
        } catch (e) {
          text += 'Unable to parse response body.';
        }
        debugResp.textContent = text;
      };

      const submitAjax = async () => {
        syncEditorHiddenFields();

        const fd = new FormData();
        fd.append('title', title.value.trim());
        fd.append('content_html', contentHtml.value);
        fd.append('content_delta', contentDelta.value);
        fd.append('isPublished', isPublished.checked ? 'true' : 'false');
        fd.append('coverIndex', coverIndexField.value);
        files.forEach(f => fd.append('images[]', f, f.name));

        const restoreBtn = window.Notify?.showButtonLoading(submitBtn, 'Saving...') || (() => {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Save Post';
        });
        debugResp.classList.add('hidden');

        try {
          const res = await fetch(API_URL, { method: 'POST', body: fd, credentials: 'include' });
          let json = null;
          try { json = await res.clone().json().catch(()=>null); } catch(e){ json = null; }

          if (!res.ok) {
            await showDebugResponse(res);
            const msg = (json && (json.error || json.message || json.details)) || `Save failed (${res.status})`;
            throw new Error(msg);
          }
          if (!json || !json.ok) {
            await showDebugResponse(res);
            const msg = (json && (json.error || json.message || json.details)) || 'Save returned false';
            throw new Error(msg);
          }

          window.Notify?.success('Blog post created successfully! Redirecting...', 2000);
          showAlert('Blog saved! Redirecting‚Ä¶', 'info', 1200);
          setTimeout(()=>{ window.location.href = './'; }, 1000);
        } catch (err) {
          console.error('submitAjax error', err);
          window.Notify?.error(err.message || 'Failed to create blog post', 5000);
          showAlert(err.message || 'Save failed', 'error', 8000);
        } finally {
          restoreBtn();
        }
      };

      form.addEventListener('submit', (e) => {
        if (!validate()) {
          e.preventDefault();
          const msg = 'Please add a title and some content. Check image limits.';
          window.Notify?.error(msg, 4000);
          showAlert(msg, 'error');
          return;
        }
        contentHtml.value  = quill.root.innerHTML;
        contentDelta.value = JSON.stringify(quill.getContents());
        if (useAjax.checked) {
          e.preventDefault();
          submitAjax();
        } else {
          // native submit fallback (not recommended)
        }
      });

      updateWordCount();
      updateSubmitState();
    })();
  </script>
</body>
</html>
